Скрипт для запуска sing-box на роутерах Asus с прошивкой Мерлина и установленным на USB-накопителе Entware.

I. Основы.

 1. Вы должны уметь составлять конфигурационные файлы для sing-box. Документация https://sing-box.sagernet.org/

 2. Поддерживаются только роутеры с архитектурами процессоров ARM/AArch (можете узнать выполнив команду 'uname -m' в консоли роутера) и версией ядра системы не ниже 4.1 (можете узнать выполнив команду 'uname -r' в консоли роутера). При не соответствии архитектуры CPU роутера или версии ядра системы этим требованиям, установка скрипта будет отменена.

 3. Если в настройках вашего роутера включено использование ipv6, то использовать данный скрипт не рекомендуется, т.к. он в большинстве случаев не сможет выполнять своё предназначение.

 4. К вашему роутеру должен быть подключен USB-накопитель с установленным Entware. В нём будут постоянно расположены ядро sing-box и конфигурационные файлы, а так же, при установке скрипта и его обновлениях, в нём будут периодически создаваться и удаляться временные файлы. Установка этих компонентов во внутреннюю память роутера не желательна, а иногда и невозможна из-за её ограничений, и не рассматривается.

 5. Если заметите баги в работе скрипта и/или сможете улучшить/оптимизировать скрипт, поделитесь информацией об этом со мной, пожалуйста.

II. Установка скрипта.
Выполните в консоли роутера команду:
wget -O /jffs/scripts/sbs https://raw.githubusercontent.com/Dr4tez/sing-box4asus/main/sbs && chmod 775 /jffs/scripts/sbs && /jffs/scripts/sbs install

III. Первоначальная настройка и запуск скрипта.
После установки скрипта, перед первым стартом sing-box, обязательно выполните его настройку! Для этого выполните следующие действия.

 1. Сначала необходимо отредактировать как минимум один шаблон конфигурационного файла sing-box, расположенный в директории /opt/root/sing-box/configs/, например config-1.json.
 Можете сделать это в меню редактирования, которое находится по следующему пути: меню 'sbs config' -> пункт 3 -> пункт 2. Обратите внимание, что редактироваться будет тот конфигурационный файл, который выбран в меню 'sbs config' -> пункт 3 -> пункт 1. Так же можете отредактировать нужный конфигурационный файл любым другим удобным для вас способом, например с помощью WinSCP.
 Как минимум, вы должны вписать в шаблон config-1.json свои значения в строки с иксами. Обратите внимание, что в нём используется мой личный рулсет, загружаемый с моей страницы гитхаба (https://github.com/Dr4tez/my_domains), в нём может не быть нужных вам заблокированных доменов. По этому шаблону трафик устройств, направленных через sing-box, маршрутизируется по следующим правилам- домены, содержащиеся в rule_set "my_domains", идут в proxy туннель, а всё остальное идёт в директ.
 Разумеется, вы можете полностью заменить шаблон на свой конфигурационный файл, главное чтобы он имел имя config-1.json, и в нём должны быть соблюдены особенности конфигурирования sing-box на роутере, указанные в разделе V данного Readme. То же касается и остальных шаблонов- config-2.json, config-3.json и config-4.json.
 Не редактируйте конфигурационные файлы при работающем sing-box. Обязательно перед этим остановите его, иначе появятся баги, от которых без определённых знаний вы не сможете самостоятельно избавиться. Но, если редактирование выполнять через меню 'sbs config', то sing-box не требуется предварительно останавливать, он будет остановлен автоматически, если редактируемый конфигурационный файл используется работающим sing-box.

 2. Затем, для входа в меню настройки маршрутизации устройств через sing-box, выполните команду 'sbs setup'. Но, в это меню вы сможете попасть, только если в вашем конфигурационном файле прописан tun или tproxy интерфейс, иначе нет смысла что-либо там настраивать, и вы только получите сообщение об этом.
  2.1 Первым пунктом этого меню является "1. Настройка IP адресов устройств для их обычной маршрутизации через sing-box."
  Внутри этого пункта находится подменю с ещё двумя пунктами- "1. Задать IP адреса для их маршрутизации через sing-box." и "2. Задать IP адреса для их исключения из маршрутизации через sing-box." Пункт 2 будет доступен для ввода значений, только если в пункте 1 была указана хотя бы одна подсеть в формате CIDR.
  2.2 Вторым пунктом этого меню является "2. Настройка IP адресов устройств для маршрутизации их через sing-box с помощью fakeip."
  Внутри этого пункта находится подменю с ещё двумя пунктами- "1. Задать IP адреса для их маршрутизации через sing-box." и "2. Задать IP адреса для их исключения из маршрутизации через sing-box." Пункт 2 будет доступен для ввода значений, только если в пункте 1 была указана хотя бы одна подсеть в формате CIDR.
  Подробнее о настройках, указанных в пунктах 2.1 и 2.2 данного раздела, читайте в разделе IV данного readme.
  2.3 Третьим пунктом этого меню является "3. Не обязательные экспертные настройки."
  Внутри этого пункта находится подменю с ещё двумя пунктами- "1. Измененить номер таблицы маршрутизации для sing-box." и "2. Изменить метку fw-mark для sing-box."
  Оба пункта в этом подменю необязательные, они для тех, кому необходимы. Если вы не знаете, для чего они нужны и какими должны быть, то не трогайте их.
  2.4 Для выхода из меню настройки маршрутизации устройств через sing-box, нажмите клавишу Enter без ввода каких-либо значений, и, если sing-box остановлен, вам будет предложено запустить sing-box. Если готовы- соглашайтесь.

IV. Настройка ip адресов устройств для направления их через sing-box с помощью обычной маршрутизации или с помощью fakeip.
В скрипте есть возможность направить ip адреса устройств через sing-box с помощью обычной маршрутизации, используя первый пункт меню 'sbs setup', или указать эти ip адреса для использования маршрутизации через sing-box с помощью fakeip, используя второй пункт меню 'sbs setup'. Обратите внимание- второй пункт (2. Настройка IP адресов устройств для маршрутизации их через sing-box с помощью fakeip.) всегда доступен для редактирования значений, но скрипт будет применять его при запуске sing-box, только если в вашем конфигурационном файле присутствуют настройки fakeip.
Для разных ситуаций могут потребоваться разные варианты конфигурационных файлов, что может потребовать от вас продвинутых навыков в их составлении.
Ниже представлены 4 варианта использования шаблонов конфигурационных файлов для sing-box версий 1.12.*, которые скачиваются при установке скрипта. Если захотите использовать один из них с другими версиями ядер sing-box, то не забудьте, при необходимости, изменить конфигурационный файл согласно разделу Migration документации sing-box https://sing-box.sagernet.org/migration/

 1. Если вы хотите направить через sing-box трафик выбранных устройств, используя только обычную маршрутизацию, то зайдите в меню 'sbs setup' с помощью соответствующей команды в командной строке роутера, далее зайдите в подменю "1. Настройка IP адресов устройств для их обычной маршрутизации через sing-box.", в первом пункте которого укажите ip адреса этих устройств.
 Если в первом пункте данного подменю вы укажете хотя бы одну подсеть в формате CIDR, например 192.168.50.0/24, то во втором его пункте вы сможете ввести ip адреса исключений из этой подсети, которые не должны направляться через sing-box, например одиночный ip адрес 192.168.50.1 или подсеть 192.168.50.0/28, которая должна быть меньшего размера, чем подсеть, указанная в первом пункте данного подменю. Одиночные ip адреса и/или подсети прописывайте в одну строку, разделяя их только пробелами. Этот абзац относится и к остальным вариантам шаблонов.
 Внимание! Если вам необходим доступ из WAN к какому-либо устройству в сети вашего роутера через переадресацию портов, то не добавляйте ip адрес этого устройства в обычную маршрутизацию через sing-box, иначе доступа к нему из WAN не будет. Это же справедливо и при добавлении в обычную маршрутизацию через sing-box всей подсети роутера- доступа из WAN через переадресацию портов не будет к вэб интерфейсу роутера и вообще ко всем устройствам подсети, кроме тех, чьи ip адреса вы указажете в пункте "2. Задать IP адреса для их исключения из маршрутизации через sing-box."
 Для этого варианта подходит шаблон конфигурационного файла с именем config-1.json. Если вы захотите использовать его при запуске sing-box, то выберите его в первом пункте меню 'sbs config'.

 2. Если вы хотите направить через sing-box трафик выбранных устройств, используя только маршрутизацию с помощью fakeip, то зайдите в меню 'sbs setup' с помощью соответствующей команды в командной строке роутера, далее зайдите в подменю "2. Настройка IP адресов устройств для маршрутизации их через sing-box с помощью fakeip.", в первом пункте которого укажите ip адреса этих устройств.
 Для этого варианта подходит шаблон конфигурационного файла с именем config-2.json. Если вы захотите использовать его при запуске sing-box, то выберите его в первом пункте меню 'sbs config'.

 3. Если вы хотите направить трафик подсети через sing-box, используя обычную маршрутизацию, а некоторые ip адреса из данной подсети маршрутизировать через sing-box с помощью fakeip, то укажите данную подсеть в первом пункте подменю "1. Настройка IP адресов устройств для их обычной маршрутизации через sing-box.", а некоторые ip адреса укажите в первом пункте подменю "2. Настройка IP адресов устройств для маршрутизации их через sing-box с помощью fakeip."
 Для этого варианта подходит шаблон конфигурационного файла с именем config-3.json. Если вы захотите использовать его при запуске sing-box, то выберите его в первом пункте меню 'sbs config'. Вместо ip адресов 192.168.50.14 и 192.168.50.15 в данном шаблоне подставьте свои ip адреса устройств, которые вы хотите маршрутизировать через sing-box с помощью fakeip.

 4. Если вы хотите направить трафик подсети через sing-box, используя маршрутизацию с помощью fakeip, а некоторые ip адреса из данной подсети направить через sing-box с помощью обычной маршрутизации, то укажите данную подсеть в первом пункте подменю "2. Настройка IP адресов устройств для маршрутизации их через sing-box с помощью fakeip.", а некоторые ip адреса укажите в первом пункте подменю "1. Настройка IP адресов устройств для их обычной маршрутизации через sing-box."
 Для этого варианта подходит шаблон конфигурационного файла с именем config-4.json. Если вы захотите использовать его при запуске sing-box, то выберите его в первом пункте меню 'sbs config'. Вместо ip адресов 192.168.50.14 и 192.168.50.15 в данном файле конфигурации подставьте свои ip адреса устройств, которые вы хотите маршрутизировать через sing-box с помощью обычной маршрутизации.

V. Особенности конфигурирования sing-box на роутере.
Тут перечислены условия, которые необходимо соблюдать при составлении конфигурационных файлов sing-box для роутера, а так же необходимые настройки в веб-интерфейсе роутера.

 1. Общие условия:
  1.1 Нельзя использовать в конфигурационных файлах следующие функции: '"auto_route": true', '"auto_detect_interface": true' и прочие, содержащие слово 'auto' в своём названии. В роутере они работают некорректно и нарушают маршрутизацию.
  1.2 Нельзя использовать в конфигурационных файлах настройку '"strict_route": true'. Она может вызывать потерю доступа к консоли роутера и нарушения маршрутизации.
  1.3 Скриптом поддерживается только один tun или tproxy интерфейс, так что не добавляйте более одного из них в ваши конфигурационные файлы.

 2. Для работы sing-box с DNS серверами, прописанными в конфигурационных файлах, необходимо выполнение всех следующих условий:
  2.1 В разделе "Локальная сеть - DHCP-сервер" вэб-интерфейса роутера: 
   1) В полях "DNS-сервер 1" и "DNS-сервер 2" должно быть пусто;
   2) В пункте "Advertise router's IP in addition to user-specified DNS" должно быть выбрано "Да";
   3) в полях "DNS-сервер (Optional)" для устройств, трафик которых вы направляете через sing-box, должно быть указано "Значение по умолчанию";
  2.2 В разделе "Локальная сеть - DNS Director" вэб-интерфейса роутера не должно быть никаких настроек для устройств, трафик которых вы направляете через sing-box.

VI. Подписки.
В скрипте с версии 2.5.0 добавлена поддержка до двух подписок. Настроить их можно в меню настроек подписок, которое находится по следующему пути: 'sbs config' -> пункт 2. В первом и втором пунктах меню настроек подписок можно ввести адреса подписок и указать для них конфигурационные файлы, в которые будет сохраняться содержимое подписок. С помощью третьего и четвёртого пунктов меню настроек подписок можно обновить настроенные подписки. Поддерживаются только подписки для sing-box, соответствующие требованиям, перечисленным в пункте 1 раздела V данного Readme. Маловероятно, что вы найдете подходящие подписки в свободном доступе. Однако, если у вас есть необходимые знания, вы можете создать подходящую подписку самостоятельно, попросить кого-нибудь сделать это за вас или вручную отредактировать файлы конфигурации, в которые сохраняются и обновляются неподдерживаемые подписки, загруженные через это меню.

VII. Настройка лимитов памяти.
У некоторых пользователей sing-box на роутерах возникает проблема постепенного поглощения всей доступной оперативной памяти процессом sing-box, что вызывает замедление работы роутера. Для её предотвращения в скрипте, начиная с версии 2.4.0, имеется меню для настройки лимитов использования оперативной памяти, вызываемое командой 'sbs limit'.

 1. Большинству пользователей достаточно будет указать лимит в пункте "1. Простая настройка." При приближении к этому лимиту, сборщик мусора GO в ядре sing-box начнёт активнее освобождать оперативную память, занятую, но фактически не используемую процессом sing-box. Если размер используемой процессом sing-box оперативной памяти всё же достигнет установленного лимита, то произойдёт перезапуск процесса.

 2. Для экспертов, разбирающихся в работе сборщика мусора GO и связанных с этим параметров в языке GO, имеется возможность вручную указать любые значения в подменю пункта "2. Не обязательные экспертные настройки." Первый пункт данного подменю задаёт жёсткий лимит, размер которого представляет собой уникальную память, используемую процессом sing-box, т.е. разницу между его RES и SHR. При достижении процессом sing-box жёсткого лимита, происходит перезапуск процесса. Особенности работы второго и третьего пунктов данного подменю должны быть знакомы экспертам.
 При приближении размера используемой процессом sing-box уникальной памяти к значению GOMEMLIMIT, нагрузка на CPU роутера начнёт расти. Чтобы перезапуск процесса sing-box происходил до чрезмерной загрузки CPU, рекомендуется использовать GOMEMLIMIT совместно с "Жёстким лимитом" и выставлять размер GOMEMLIMIT примерно на 10% больше, чем "Жёсткий лимит".

VIII. Основные команды управления скриптом.
Для запуска скрипта sing-box выполните в консоли роутера команду:
sbs start
Если хотите полностью остановить работу скрипта и не хотите, чтобы скрипт самостоятельно запускался при перезагрузке роутера, то выполните команду:
sbs stop
Для удаления скрипта и всех результатов его деятельности выполните команду:
sbs remove
Полный список команд с их описанием можете увидеть, выполнив команду:
sbs

IX. Обновление скрипта.

 1. Начиная с версии скрипта 1.8, обновление до новейшей версии осуществляется через меню, вызываемое командой 'sbs update', в котором надо просто выбрать первый пункт.

 2. Корректно обновиться до новейшей версии скрипта с версий 1.7 и более старых можно только полной переустановкой скрипта.

X. Про ядро sing-box.

 1. Во время установки скрипта, по умолчанию скачивается и устанавливается новейший стабильный релиз ядра sing-box со страницы https://github.com/SagerNet/sing-box/releases/latest разработчика sing-box.

 2. Если вместо оригинального репозитория разработчика sing-box вы хотите использовать кастомный репозиторий (форк) с расширенным функционалом ядра sing-box, то можете задать и выбрать его в подменю выбора репозитория, которое находится по следующему пути: меню 'sbs update' -> пункт 3 -> пункт 1.
 Пример задания кастомного репозитория- 'shtorm-7/sing-box-extended' Его полный адрес- https://github.com/shtorm-7/sing-box-extended/ Данный форк имеет интегрированную поддержку AmneziaWG, XHTTP и некоторые другие усовершенствования, отсутствующие в оригинальном репозитории. Однако, я не контроллирую код репозитория shtorm-7/sing-box-extended, как и любого другого, и не гарантирую их безопасность и работоспособность.

 3. Если вместо новейшего стабильного релиза ядра sing-box вы хотите использовать другую версию ядра, то можете выбрать её в меню выбора версии ядра, которое находится по следующему пути: меню 'sbs update' -> пункт 3 -> пункт 2. В этом меню доступен выбор новейшего стабильного релиза, новейшего пре-релиза или заданной версии.
 В этом же меню можно задать глубину поиска, например '90'. В результате заданная версия, как и новейший стабильный релиз или новейший пре-релиз, будет искаться среди заданного числа последних релизов. Если не задано, то используется значение по умолчанию- 30.
 После смены версии ядра, не забудьте, при необходимости, изменить конфигурационный файл согласно разделу Migration (https://sing-box.sagernet.org/migration/) документации sing-box.