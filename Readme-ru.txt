Скрипт для запуска sing-box на роутерах Asus с прошивкой Мерлина и установленным на USB-накопителе Entware.

I. Основы.

 1. Вы должны уметь составлять конфигурационные файлы для sing-box. Документация https://sing-box.sagernet.org/.

 2. Поддерживаются только роутеры с архитектурами процессоров ARM/AArch (можете узнать выполнив команду 'uname -m' в консоли роутера) и версией ядра системы не ниже 4.1 (можете узнать выполнив команду 'uname -r' в консоли роутера). При не соответствии архитектуры CPU роутера или версии ядра системы этим требованиям, установка скрипта будет отменена.

 3. Если в настройках вашего роутера включено использование ipv6, то использовать данный скрипт не рекомендуется, т.к. он в большинстве случаев не сможет выполнять своё предназначение.

 4. К вашему роутеру должен быть подключен USB-накопитель с установленным Entwar. В нём будет постоянно расположено ядро sing-box, а так же, при установке скрипта и его обновлениях, будут периодически создаваться и удаляться временные файлы. Установка этих компонентов во внутреннюю память роутера не желательна, а иногда и невозможна из-за её ограничений, и не рассматривается.

 5. Если заметите баги в работе скрипта и/или сможете улучшить/оптимизировать скрипт, поделитесь информацией об этом со мной, пожалуйста.

II. Установка скрипта.
Выполните в консоли роутера команду:
wget -O /jffs/scripts/sbs https://raw.githubusercontent.com/Dr4tez/sing-box4asus/main/sbs && chmod 775 /jffs/scripts/sbs && /jffs/scripts/sbs install

III. Первоначальная настройка и запуск скрипта.
После установки скрипта, перед первым стартом sing-box, обязательно выполните его настройку! Для этого выполните следующие действия.

 1. Сначала необходимо отредактировать шаблон конфигурационного файла sing-box, расположенный по пути /jffs/addons/sing-box-script/config.json.
 Можете сделать это в меню, вызываемом командой 'sbs config', выбрав там первый пункт. Так же можете сделать это любым другим удобным для вас способом, например с помощью WinSCP.
 Как минимум, вы должны вписать в шаблон config.json свои значения в строки с иксами. Обратите внимание, что в нём используется мой личный рулсет, загружаемый с моей страницы гитхаба (https://github.com/Dr4tez/my_domains), в нём может не быть нужных вам заблокированных доменов. По этому шаблону трафик устройств, направленных через sing-box, маршрутизируется по следующим правилам- домены, содержащиеся в rule_set "my_domains", идут в proxy туннель, а всё остальное идёт в директ.
 Разумеется, вы можете полностью заменить шаблон на свой конфигурационный файл, главное чтобы он имел имя config.json, и в нём должны быть соблюдены особенности конфигурирования sing-box на роутере, указанные в разделе V данного Readme.
 Не редактируйте конфигурационный файл config.json при работающем sing-box. Обязательно перед этим остановите его, иначе появятся баги, от которых без определённых знаний вы не сможете самостоятельно избавиться. Но если для редактирования config.json использовать первый пункт меню 'sbs config', sing-box не потребуется предварительно останавливать, он будет остановлен автоматически.

 2. Затем, для входа в меню настройки скрипта выполните команду 'sbs setup'. Но, в это меню вы сможете попасть, только если в вашем config.json прописан tun или tproxy интерфейс, иначе вам там нечего настраивать, и вы только получите сообщение об этом.
  2.1 Первым пунктом этого меню является настройка ip адресов устройств, трафик которых вы хотите пустить через sing-box.
  2.2 Если ваш файл config.json содержит настройки для работы через fakeip, то вторым пунктом меню настройки скрипта будет настройка ip адресов устройств, которые должны работать через fakeip.
  Подробнее о настройках, указанных в пунктах 2.1 и 2.2 данного раздела, читайте в разделе IV данного readme.
  2.3 Следующим пунктом меню настройки скрипта будет подменю продвинутых, но не обязательных настроек.
  В нём вы можете сменить номер таблицы маршрутизации для sing-box. Так же, если в вашем конфигурационном файле sing-box прописан tproxy интерфейс, там будет возможность смены метки tproxy-mark.
  Все пункты в этом подменю необязательные, они для тех, кому необходимы. Если вы не знаете, для чего они нужны и какими должны быть, то не трогайте их.
  2.4 При выборе пункта 0 для выхода из меню настройки скрипта, вам будет предложено запустить sing-box. Если готовы- соглашайтесь.

IV. Про настройки ip адресов устройств для направления их через обычную маршрутизацию или fakeip.
В скрипте есть возможность направить ip адреса устройств через обычную маршрутизацию с помощью первого пункта меню 'sbs setup', и/или указать их для использования fakeip через второй пункт меню 'sbs setup', который появится только если в файле config.json присутствуют настройки fakeip. Для разных вариантов требуются разные соответствующим образом составленные конфигурационные файлы sing-box, что требует от вас продвинутых навыков в их составлении.
Шаблоны конфигурационных файлов для ядер sing-box 1.11.* для всех перечисленных ниже вариантов вы можете найти на странице данного проекта https://github.com/Dr4tez/sing-box4asus. Если захотите использовать один из них с другими версиями ядер sing-box, то не забудьте, при необходимости, изменить конфиг согласно разделу Migration документации sing-box https://sing-box.sagernet.org/migration/.

 1. Если вы хотите направить ip адреса устройств только через обычную маршрутизацию, то укажите их только в первом пункте меню 'sbs setup'. Если тут вы укажете подсеть в формате CIDR, например 192.168.50.0/24, то после её ввода появится предложение ввести ip адреса исключений, которые не должны направляться через sing-box.
 ip адреса прописывайте в одну строку, разделяя их только пробелами. Это относится и к последующим вариантам.
 Внимание! Если вам необходим доступ из WAN к какому-либо устройству в сети вашего роутера через переадресацию портов, то не добавляйте ip адрес этого устройства в первом пункте меню 'sbs setup', иначе доступа не будет. Это же справедливо и при добавлении всей подсети- доступа из WAN через переадресацию портов не будет к вэб интерфейсу роутера и ко всем устройствам подсети, кроме тех, чьи ip адреса вы указажете на этапе ввода ip адресов исключений.
 Для этого варианта подходит шаблон конфигурационного файла sing-box с именем config.json, автоматически скачиваемый при установке скрипта.

 2. Если вы хотите настроить ip адреса для работы только через fakeip, то укажите их только во втором пункте меню 'sbs setup'. Если тут вы укажете подсеть в формате CIDR, то после её ввода появится предложение ввести ip адреса исключений, которые не должны работать через fakeip.
 Для этого варианта шаблон конфигурационного файла sing-box называется config-2.json. Если вы захотите использовать его, то просто скопируйте его содержимое в файл config.json, скачанный при установке скрипта, заменив его содержимое.

 3. Если вы хотите через обычную маршрутизацию направить всю подсеть, указав её в первом пункте меню 'sbs setup', а некоторые ip адреса из неё настроить для работы через fakeip, то укажите эти ip адреса во втором пункте.
 Для этого варианта шаблон конфигурационного файла sing-box называется config-3.json. Если вы захотите использовать его, то просто скопируйте его содержимое в файл config.json, скачанный при установке скрипта, заменив его содержимое. Вместо ip адресов 192.168.50.14 и 192.168.50.15 в данном файле конфигурации можете вставить свои ip адреса устройств, которые вы хотите настроить для работы через fakeip.

 4. Если вы хотите через fakeip направить всю подсеть, указав её во втором пункте меню 'sbs setup', а некоторые ip адреса из неё настроить для работы через обычную маршрутизацию, то укажите эти ip адреса в первом пункте.
 Для этого варианта шаблон конфигурационного файла sing-box называется config-4.json. Если вы захотите использовать его, то просто скопируйте его содержимое в файл config.json, скачанный при установке скрипта, заменив его содержимое. Вместо ip адресов 192.168.50.14 и 192.168.50.15 в данном файле конфигурации можете вставить свои ip адреса устройств, которые вы хотите направить через sing-box с помощью обычной маршрутизации.

V. Особенности конфигурирования sing-box на роутере.
Тут перечислены условия, которые необходимо соблюдать при составлении конфигурационных файлов sing-box для роутера, а так же необходимые настройки в веб-интерфейсе роутера.

 1. Общие условия:
  1.1 Не используйте в вашем config.json следующие функции: '"auto_route": true', '"auto_detect_interface": true' и прочие, содержащие слово 'auto' в своём названии. В роутере они работают некорректно и нарушают маршрутизацию.
  1.2 Не используйте в config.json настройку '"strict_route": true', это может вызывать потерю доступа к консоли роутера и нарушения маршрутизации.
  1.3 Скриптом поддерживается только один tun или tproxy интерфейс, так что не добавляйте их больше одного в config.json.

 2. Для работы sing-box с DNS серверами, прописанными в config.json, необходимо выполнение всех следующих условий:
  2.1 В разделе "Локальная сеть - DHCP-сервер" вэб-интерфейса роутера: 
   1) В полях "DNS-сервер 1" и "DNS-сервер 2" должно быть пусто;
   2) В пункте "Advertise router's IP in addition to user-specified DNS" должно быть выбрано "Да";
   3) в полях "DNS-сервер (Optional)" для устройств, трафик которых вы направляете через sing-box, должно быть указано "Значение по умолчанию";
  2.2 В разделе "Локальная сеть - DNS Director" вэб-интерфейса роутера не должно быть никаких настроек для устройств, трафик которых вы направляете через sing-box.
  2.3 В config.json в секции inbounds должен присутствовать следующий блок:  
    {
      "type": "direct",
      "tag": "dns-in",
      "listen": "0.0.0.0",
      "listen_port": 55553,
      "override_port": 5553
    }
  Этот блок представляет собой inbound (входящий) direct интерфейс под именем dns-in. Он принимает на порт 55553 DNS запросы от устройств, трафик которых направляется через sing-box, и переопределяет их на порт 5553. Значение listen_port не обязательно должно быть 55553, если этот порт уже занят вашим роутером для других целей, можете вместо него вписать любой свободный 4-х или 5-значный. Значение override_port не обязательно должно быть 5553, если этот порт уже занят вашим роутером или sing-box для других целей, можете вместо него вписать любой свободный 4-х или 5-значный.
  В шаблоне моего config.json, скачиваемом при установке скрипта, эти блок присутствует.

VI. Команды управления скриптом.
Для запуска скрипта sing-box выполните в консоли роутера команду:
sbs start
Если хотите полностью остановить работу скрипта и не хотите, чтобы скрипт самостоятельно запускался при перезагрузке роутера, то выполните команду:
sbs stop
Для удаления скрипта и всех результатов его деятельности выполните команду:
sbs remove
Полный список команд с их описанием можете увидеть, выполнив команду:
sbs

VII. Обновление скрипта.

 1. С версий скрипта 1.8 и более новых обновление до новейшей версии осуществляется через меню, вызываемое командой 'sbs update', в котором надо просто выбрать первый пункт.

 2. Обновиться до новейшей версии скрипта с версий 1.7 и более старых можно только переустановкой скрипта по следующей инструкции:
  1) Cохраните куда-нибудь свой файл конфигурации config.json, лежащий в директории /jffs/addons/sing-box-script.
  2) Удалите прошлую версию с помощью команды 'sbs remove' в командной строке роутера.
  3) Выполните установку новейшей версии, выполнив в командной строке роутера команду:
wget -O /jffs/scripts/sbs https://raw.githubusercontent.com/Dr4tez/sing-box4asus/main/sbs && chmod 775 /jffs/scripts/sbs && /jffs/scripts/sbs install
  4) Поместите свой файл конфигурации config.json в директорию /jffs/addons/sing-box-script вместо шаблона, скачанного при установке скрипта.
  5) Настройте скрипт, согласно разделу III данного Readme, выполнив команду 'sbs setup' в командной строке роутера.

VIII. Про ядро sing-box.

 1. Во время установки скрипта, по умолчанию скачивается и устанавливается новейший стабильный релиз ядра sing-box со страницы https://github.com/SagerNet/sing-box/releases/latest гитхаба разработчика.

 2. Если вместо оригинального репозитория разработчика sing-box вы хотите использовать кастомный репозиторий (форк) с расширенным функционалом ядра sing-box, то можете задать и выбрать его в меню выбора репозитория, которое находится по следующему пути: меню 'sbs update'->пункт 3->пункт 1. Доступно задание до двух кастомных репозиториев. Например мой с интегрированной поддержкой AmneziaWG: Dr4tez/sing-box-mod (https://github.com/Dr4tez/sing-box-mod/releases). Код для добавления поддержки AmneziaWG в мой репозиторий взят из репозитория shtorm-7/sing-box-extended (https://github.com/shtorm-7/sing-box-extended/releases), который при желании так же можете добавить. Ядра sing-box в нём имеют более расширенный функционал, но, при его использовании, как и любых других сторонних репозиториев, на мою поддержку не рассчитывайте, т.к. я не могу постоянно отслеживать их код и гарантировать их безопасность и работоспособность.
 Образец использования AmneziaWG в wireguard endpoint, при использовании ядра sing-box из репозиториев Dr4tez/sing-box-mod или shtorm-7/sing-box-extended, есть в файле AmneziaWG_example.txt на странице данного проекта https://github.com/Dr4tez/sing-box4asus

 3. Если вместо новейшего стабильного релиза ядра sing-box вы хотите использовать другую версию ядра, то можете выбрать её в меню выбора версии ядра, которое находится по следующему пути: меню 'sbs update'->пункт 3->пункт 2. В этом меню доступен выбор новейшего стабильного релиза, новейшего пре-релиза или заданной версии.
 В этом же меню можно задать глубину поиска, например '90', и заданная версия, а так же новейший стабильный релиз или новейший пре-релиз будут искаться среди заданного числа последних релизов. Если не задано, то используется значение по умолчанию- 30.
 После смены версии ядра, не забудьте, при необходимости, изменить конфиг согласно разделу Migration (https://sing-box.sagernet.org/migration/) документации sing-box.
